<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory Orchestrator</title>
    <link rel="stylesheet" href="../css/shared.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --info-color: #0284c7;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --background-color: #ffffff;
            --surface-color: #f9fafb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--surface-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: var(--background-color);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .breadcrumb {
            background: var(--surface-color);
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--background-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .nav-tab:hover {
            color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grid Layouts */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .full-width-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Cards */
        .card {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .card h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
        }

        /* Pipeline Execution Form */
        .pipeline-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--surface-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: var(--success-color); }
        .status-offline { background: var(--error-color); }
        .status-warning { background: var(--warning-color); }

        /* Metrics Cards */
        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .metric-change {
            font-size: 12px;
            margin-top: 4px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .metric-up {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
        }

        .metric-down {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error-color);
        }

        /* Pipeline History */
        .pipeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .pipeline-table th,
        .pipeline-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .pipeline-table th {
            font-weight: 600;
            background: var(--surface-color);
        }

        .pipeline-table tr:hover {
            background: var(--surface-color);
        }

        /* Pipeline Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-completed { background: rgba(5, 150, 105, 0.1); color: var(--success-color); }
        .status-running { background: rgba(2, 132, 199, 0.1); color: var(--info-color); }
        .status-failed { background: rgba(220, 38, 38, 0.1); color: var(--error-color); }
        .status-partial { background: rgba(217, 119, 6, 0.1); color: var(--warning-color); }

        /* Worker Health Grid */
        .worker-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .worker-health-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
        }

        .worker-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .worker-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .worker-status {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .alert-warning {
            background: rgba(217, 119, 6, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .alert-info {
            background: rgba(2, 132, 199, 0.1);
            border-color: var(--info-color);
            color: var(--info-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .dashboard-grid,
            .two-column-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 16px;
            }
        }

        /* Pipeline Visualization */
        .pipeline-viz {
            display: flex;
            align-items: center;
            gap: 16px;
            overflow-x: auto;
            padding: 16px;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            margin-top: 16px;
        }

        .viz-step {
            flex-shrink: 0;
            background: var(--background-color);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
            min-width: 120px;
            transition: var(--transition);
        }

        .viz-step.active {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .viz-step.completed {
            border-color: var(--success-color);
            background: rgba(5, 150, 105, 0.05);
        }

        .viz-step.failed {
            border-color: var(--error-color);
            background: rgba(220, 38, 38, 0.05);
        }

        .viz-arrow {
            font-size: 16px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading AI Factory Orchestrator...</p>
    </div>

    <!-- Main Application -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üéØ AI Factory Orchestrator</h1>
            </div>
            <div class="header-right">
                <span id="user-info" class="text-secondary">Welcome back</span>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </header>

        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb">
            <a href="../">‚Üê Back to Main Dashboard</a>
        </nav>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="pipeline">Pipeline Execution</button>
            <button class="nav-tab" data-tab="monitoring">System Monitoring</button>
            <button class="nav-tab" data-tab="history">Pipeline History</button>
            <button class="nav-tab" data-tab="analytics">Analytics</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Pipeline Execution Tab -->
            <div id="tab-pipeline" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Pipeline Execution Form -->
                    <div class="card">
                        <h2>üöÄ Start New Pipeline</h2>
                        <form id="pipeline-form" class="pipeline-form">
                            <div class="form-group">
                                <label for="topic">Research Topic *</label>
                                <input type="text" id="topic" name="topic" placeholder="e.g., artificial intelligence, renewable energy" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="strategy">Execution Strategy</label>
                                    <select id="strategy" name="optimize_for">
                                        <option value="balanced">üéØ Balanced (Recommended)</option>
                                        <option value="speed">‚ö° Speed Optimized</option>
                                        <option value="cost">üí∞ Cost Optimized</option>
                                        <option value="quality">üéì Quality Optimized</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="urgency">Urgency Level</label>
                                    <select id="urgency" name="urgency">
                                        <option value="low">üêå Low (5+ minutes)</option>
                                        <option value="medium" selected>üö∂ Medium (2-3 minutes)</option>
                                        <option value="high">üèÉ High (< 1 minute)</option>
                                        <option value="critical">üö® Critical (Emergency)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quality_level">Quality Level</label>
                                    <select id="quality_level" name="quality_level">
                                        <option value="basic">üìù Basic</option>
                                        <option value="standard" selected>üìä Standard</option>
                                        <option value="premium">‚≠ê Premium</option>
                                        <option value="enterprise">üíé Enterprise</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="budget_limit">Budget Limit (USD)</label>
                                    <input type="number" id="budget_limit" name="budget_limit" min="0.10" max="10.00" step="0.10" value="2.00">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="parallel_processing" name="enable_parallel_processing" checked>
                                    Enable Parallel Processing (Faster execution)
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                üöÄ Launch Pipeline
                            </button>
                        </form>
                    </div>

                    <!-- Real-time Pipeline Status -->
                    <div class="card">
                        <h2>üìä Current Pipeline Status</h2>
                        <div id="current-pipeline-status">
                            <p class="text-secondary">No active pipeline</p>
                        </div>

                        <!-- Pipeline Visualization -->
                        <div id="pipeline-visualization" style="display: none;">
                            <h3>Pipeline Progress</h3>
                            <div class="pipeline-viz">
                                <div class="viz-step" id="step-topic-researcher">
                                    <div>üîç</div>
                                    <div>Topic Research</div>
                                </div>
                                <div class="viz-arrow">‚Üí</div>
                                <div class="viz-step" id="step-rss-librarian">
                                    <div>üìö</div>
                                    <div>Source Management</div>
                                </div>
                                <div class="viz-arrow">‚Üí</div>
                                <div class="viz-step" id="step-feed-fetcher">
                                    <div>üì°</div>
                                    <div>Article Fetching</div>
                                </div>
                                <div class="viz-arrow">‚Üí</div>
                                <div class="viz-step" id="step-content-classifier">
                                    <div>üß†</div>
                                    <div>AI Analysis</div>
                                </div>
                                <div class="viz-arrow">‚Üí</div>
                                <div class="viz-step" id="step-report-builder">
                                    <div>üìä</div>
                                    <div>Report Generation</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Pipeline Results -->
                <div class="card">
                    <h2>üìà Recent Pipeline Results</h2>
                    <div id="recent-results">
                        <p class="text-secondary">No recent pipelines executed</p>
                    </div>
                </div>
            </div>

            <!-- System Monitoring Tab -->
            <div id="tab-monitoring" class="tab-content">
                <div class="dashboard-grid">
                    <!-- System Overview -->
                    <div class="card metric-card">
                        <div class="metric-value" id="active-workers">-</div>
                        <div class="metric-label">Active Workers</div>
                        <div class="metric-change metric-up" id="worker-change">All Online</div>
                    </div>

                    <div class="card metric-card">
                        <div class="metric-value" id="pipelines-today">-</div>
                        <div class="metric-label">Pipelines Today</div>
                        <div class="metric-change" id="pipeline-change">-</div>
                    </div>

                    <div class="card metric-card">
                        <div class="metric-value" id="avg-execution-time">-</div>
                        <div class="metric-label">Avg Execution Time</div>
                        <div class="metric-change" id="time-change">-</div>
                    </div>

                    <div class="card metric-card">
                        <div class="metric-value" id="total-cost">-</div>
                        <div class="metric-label">Cost Today</div>
                        <div class="metric-change" id="cost-change">-</div>
                    </div>
                </div>

                <!-- Worker Health Status -->
                <div class="card">
                    <h2>üè• Worker Health Status</h2>
                    <div class="worker-health-grid" id="worker-health-grid">
                        <!-- Worker health cards will be populated here -->
                    </div>
                </div>

                <!-- System Alerts -->
                <div class="card">
                    <h2>üö® System Alerts</h2>
                    <div id="system-alerts">
                        <p class="text-secondary">No active alerts</p>
                    </div>
                </div>
            </div>

            <!-- Pipeline History Tab -->
            <div id="tab-history" class="tab-content">
                <div class="card">
                    <h2>üìä Pipeline Execution History</h2>
                    
                    <!-- Filters -->
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="history-filter-status">Filter by Status</label>
                            <select id="history-filter-status">
                                <option value="">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="partial">Partial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="history-filter-strategy">Filter by Strategy</label>
                            <select id="history-filter-strategy">
                                <option value="">All Strategies</option>
                                <option value="balanced">Balanced</option>
                                <option value="speed_optimized">Speed Optimized</option>
                                <option value="cost_optimized">Cost Optimized</option>
                                <option value="quality_optimized">Quality Optimized</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pipeline History Table -->
                    <div id="pipeline-history-container">
                        <table class="pipeline-table">
                            <thead>
                                <tr>
                                    <th>Pipeline ID</th>
                                    <th>Topic</th>
                                    <th>Strategy</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Cost</th>
                                    <th>Articles</th>
                                    <th>Started</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pipeline-history-tbody">
                                <tr>
                                    <td colspan="9" class="text-secondary">Loading pipeline history...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="tab-analytics" class="tab-content">
                <div class="dashboard-grid">
                    <!-- Performance Metrics -->
                    <div class="card">
                        <h2>‚ö° Performance Insights</h2>
                        <div id="performance-insights">
                            <p class="text-secondary">Loading performance data...</p>
                        </div>
                    </div>

                    <!-- Cost Analysis -->
                    <div class="card">
                        <h2>üí∞ Cost Analysis</h2>
                        <div id="cost-analysis">
                            <p class="text-secondary">Loading cost analysis...</p>
                        </div>
                    </div>

                    <!-- Optimization Recommendations -->
                    <div class="card">
                        <h2>üéØ Optimization Recommendations</h2>
                        <div id="optimization-recommendations">
                            <p class="text-secondary">Loading recommendations...</p>
                        </div>
                    </div>

                    <!-- Worker Performance -->
                    <div class="card">
                        <h2>üë• Worker Performance</h2>
                        <div id="worker-performance">
                            <p class="text-secondary">Loading worker performance...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/shared/auth.js"></script>
    <script src="../js/shared/api.js"></script>
    <script src="../js/shared/ui.js"></script>
    <script>
        // Orchestrator Dashboard Controller
        class OrchestratorDashboard {
            constructor() {
                this.authClient = window.authClient;
                this.apiClient = window.apiClient;
                this.activeTab = 'pipeline';
                this.refreshInterval = null;
                this.currentPipelineId = null;
                
                this.init();
            }

            async init() {
                // Show loading screen
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Check authentication
                if (!this.authClient || !this.authClient.isAuthenticated()) {
                    window.location.href = '../';
                    return;
                }

                const validation = await this.authClient.validateSession();
                if (!validation.valid) {
                    window.location.href = '../';
                    return;
                }

                // Hide loading screen and show app
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Update user info
                document.getElementById('user-info').textContent = `Welcome, ${validation.user.username}`;

                // Setup event listeners
                this.setupEventListeners();

                // Load initial data
                await this.loadDashboardData();

                // Start refresh intervals
                this.startRefreshIntervals();
            }

            setupEventListeners() {
                // Logout button
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await this.authClient.logout();
                    window.location.href = '../';
                });

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Pipeline form submission
                document.getElementById('pipeline-form').addEventListener('submit', this.handlePipelineSubmission.bind(this));

                // History filters
                document.getElementById('history-filter-status').addEventListener('change', this.filterPipelineHistory.bind(this));
                document.getElementById('history-filter-strategy').addEventListener('change', this.filterPipelineHistory.bind(this));
            }

            switchTab(tabName) {
                // Update active tab button
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Show active tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');

                this.activeTab = tabName;

                // Load tab-specific data
                this.loadTabData(tabName);
            }

            async loadTabData(tabName) {
                switch (tabName) {
                    case 'monitoring':
                        await this.loadMonitoringData();
                        break;
                    case 'history':
                        await this.loadPipelineHistory();
                        break;
                    case 'analytics':
                        await this.loadAnalyticsData();
                        break;
                }
            }

            async loadDashboardData() {
                // Load basic health data for all tabs
                await this.updateSystemHealth();
            }

            async updateSystemHealth() {
                try {
                    // Get pipeline health
                    const healthData = await this.apiClient.callWorker('orchestrator', '/pipeline-health');
                    
                    const activeWorkers = healthData.workers ? 
                        Object.values(healthData.workers).filter(w => w.status === 'online').length : 0;
                    const totalWorkers = healthData.workers ? Object.keys(healthData.workers).length : 6;

                    document.getElementById('active-workers').textContent = `${activeWorkers}/${totalWorkers}`;

                    // Update worker health grid if monitoring tab is active
                    if (this.activeTab === 'monitoring') {
                        this.updateWorkerHealthGrid(healthData.workers);
                    }

                } catch (error) {
                    console.error('Failed to update system health:', error);
                    document.getElementById('active-workers').textContent = 'Error';
                }
            }

            updateWorkerHealthGrid(workers) {
                const grid = document.getElementById('worker-health-grid');
                if (!workers || !grid) return;

                const workerIcons = {
                    'orchestrator': 'üéØ',
                    'topic-researcher': 'üîç',
                    'rss-librarian': 'üìö',
                    'feed-fetcher': 'üì°',
                    'content-classifier': 'üß†',
                    'report-builder': 'üìä'
                };

                grid.innerHTML = Object.entries(workers).map(([name, data]) => `
                    <div class="worker-health-card">
                        <div class="worker-icon">${workerIcons[name] || '‚öôÔ∏è'}</div>
                        <div class="worker-name">${name.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                        <div class="worker-status">
                            <span class="status-dot status-${data.status === 'online' ? 'online' : 'offline'}"></span>
                            ${data.status || 'Unknown'}
                        </div>
                        ${data.response_time_ms ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${data.response_time_ms}ms</div>` : ''}
                    </div>
                `).join('');
            }

            async loadMonitoringData() {
                try {
                    // Load performance insights
                    const insights = await this.apiClient.callWorker('orchestrator', '/performance-insights?time_range=24h');
                    
                    if (insights.metrics) {
                        document.getElementById('pipelines-today').textContent = insights.metrics.total_pipelines || '0';
                        document.getElementById('avg-execution-time').textContent = 
                            insights.metrics.avg_execution_time_ms ? `${Math.round(insights.metrics.avg_execution_time_ms / 1000)}s` : '-';
                        document.getElementById('total-cost').textContent = 
                            insights.metrics.total_cost_usd ? `$${insights.metrics.total_cost_usd.toFixed(2)}` : '$0.00';
                    }

                } catch (error) {
                    console.error('Failed to load monitoring data:', error);
                }
            }

            async loadPipelineHistory() {
                const tbody = document.getElementById('pipeline-history-tbody');
                tbody.innerHTML = '<tr><td colspan="9" class="text-secondary">Loading pipeline history...</td></tr>';

                try {
                    // For now, we'll use mock data since the API doesn't have a history endpoint
                    // In production, this would call an actual history endpoint
                    
                    const mockHistory = [
                        {
                            pipeline_id: 'pipe_1753211374822_5s9fccq3i',
                            topic: 'artificial intelligence',
                            strategy: 'quality_optimized',
                            status: 'completed',
                            total_execution_time_ms: 2340,
                            total_cost_usd: 0.23,
                            articles_processed: 142,
                            started_at: new Date(Date.now() - 3600000).toISOString()
                        },
                        {
                            pipeline_id: 'pipe_1753211374822_abc123',
                            topic: 'renewable energy',
                            strategy: 'balanced',
                            status: 'completed',
                            total_execution_time_ms: 1890,
                            total_cost_usd: 0.18,
                            articles_processed: 98,
                            started_at: new Date(Date.now() - 7200000).toISOString()
                        }
                    ];

                    this.renderPipelineHistory(mockHistory);

                } catch (error) {
                    console.error('Failed to load pipeline history:', error);
                    tbody.innerHTML = '<tr><td colspan="9" class="text-secondary">Failed to load pipeline history</td></tr>';
                }
            }

            renderPipelineHistory(pipelines) {
                const tbody = document.getElementById('pipeline-history-tbody');
                
                if (pipelines.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-secondary">No pipeline history found</td></tr>';
                    return;
                }

                tbody.innerHTML = pipelines.map(pipeline => `
                    <tr>
                        <td><code>${pipeline.pipeline_id.substring(0, 12)}...</code></td>
                        <td>${pipeline.topic}</td>
                        <td>${pipeline.strategy.replace('_', ' ')}</td>
                        <td><span class="status-badge status-${pipeline.status}">${pipeline.status}</span></td>
                        <td>${Math.round(pipeline.total_execution_time_ms / 1000)}s</td>
                        <td>$${pipeline.total_cost_usd.toFixed(3)}</td>
                        <td>${pipeline.articles_processed}</td>
                        <td>${new Date(pipeline.started_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="orchestratorDashboard.viewPipelineDetails('${pipeline.pipeline_id}')">
                                View
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            async loadAnalyticsData() {
                try {
                    const insights = await this.apiClient.callWorker('orchestrator', '/performance-insights?time_range=7d');
                    
                    // Performance insights
                    const perfElement = document.getElementById('performance-insights');
                    if (insights.performance_trends) {
                        perfElement.innerHTML = `
                            <div style="margin-bottom: 16px;">
                                <h4>Execution Times</h4>
                                <p>Average: ${insights.performance_trends.avg_execution_time || 'N/A'}</p>
                                <p>Fastest: ${insights.performance_trends.fastest_time || 'N/A'}</p>
                                <p>Slowest: ${insights.performance_trends.slowest_time || 'N/A'}</p>
                            </div>
                            <div>
                                <h4>Success Rate</h4>
                                <p>${insights.performance_trends.success_rate || 'N/A'}% successful pipelines</p>
                            </div>
                        `;
                    } else {
                        perfElement.innerHTML = '<p class="text-secondary">No performance data available</p>';
                    }

                    // Cost analysis
                    const costElement = document.getElementById('cost-analysis');
                    if (insights.cost_analysis) {
                        costElement.innerHTML = `
                            <div style="margin-bottom: 16px;">
                                <h4>Cost Breakdown</h4>
                                <p>Total Cost (7d): $${insights.cost_analysis.total_cost || '0.00'}</p>
                                <p>Average per Pipeline: $${insights.cost_analysis.avg_cost_per_pipeline || '0.00'}</p>
                                <p>Most Expensive: $${insights.cost_analysis.max_cost || '0.00'}</p>
                            </div>
                        `;
                    } else {
                        costElement.innerHTML = '<p class="text-secondary">No cost data available</p>';
                    }

                    // Optimization recommendations
                    const optElement = document.getElementById('optimization-recommendations');
                    if (insights.recommendations) {
                        optElement.innerHTML = insights.recommendations.map(rec => `
                            <div class="alert alert-info" style="margin-bottom: 8px;">
                                ${rec}
                            </div>
                        `).join('');
                    } else {
                        optElement.innerHTML = '<div class="alert alert-success">System is running optimally!</div>';
                    }

                } catch (error) {
                    console.error('Failed to load analytics data:', error);
                    document.getElementById('performance-insights').innerHTML = '<p class="text-secondary">Failed to load analytics</p>';
                }
            }

            async handlePipelineSubmission(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const pipelineRequest = {
                    topic: formData.get('topic'),
                    urgency: formData.get('urgency'),
                    quality_level: formData.get('quality_level'),
                    optimize_for: formData.get('optimize_for'),
                    budget_limit: parseFloat(formData.get('budget_limit')),
                    enable_parallel_processing: formData.has('enable_parallel_processing')
                };

                // Show pipeline starting status
                this.showPipelineProgress('Starting pipeline...');
                
                try {
                    const result = await this.apiClient.callWorker('orchestrator', '/orchestrate', pipelineRequest);
                    
                    if (result.status === 'completed') {
                        this.showPipelineResult(result);
                        this.currentPipelineId = result.pipeline_id;
                    } else if (result.status === 'partial') {
                        this.showPipelineWarning(result);
                    } else {
                        this.showPipelineError('Pipeline execution failed');
                    }

                } catch (error) {
                    console.error('Pipeline execution failed:', error);
                    this.showPipelineError(error.message || 'Pipeline execution failed');
                }
            }

            showPipelineProgress(message) {
                const statusDiv = document.getElementById('current-pipeline-status');
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                            ${message}
                        </div>
                    </div>
                `;
                
                document.getElementById('pipeline-visualization').style.display = 'block';
                this.animatePipelineSteps();
            }

            showPipelineResult(result) {
                const statusDiv = document.getElementById('current-pipeline-status');
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Pipeline Completed Successfully!</h4>
                        <p><strong>Pipeline ID:</strong> ${result.pipeline_id}</p>
                        <p><strong>Execution Time:</strong> ${Math.round(result.total_execution_time_ms / 1000)}s</p>
                        <p><strong>Articles Processed:</strong> ${result.articles_processed}</p>
                        <p><strong>Cost:</strong> $${result.total_cost_usd?.toFixed(3) || '0.000'}</p>
                        <p><strong>Strategy:</strong> ${result.execution_strategy}</p>
                        ${result.intelligence_report ? `
                            <div style="margin-top: 16px;">
                                <h5>Intelligence Report:</h5>
                                <div style="background: var(--surface-color); padding: 12px; border-radius: 4px; font-size: 14px;">
                                    ${result.intelligence_report.substring(0, 200)}...
                                </div>
                            </div>
                        ` : ''}
                        <button class="btn btn-primary" style="margin-top: 12px;" onclick="orchestratorDashboard.viewPipelineDetails('${result.pipeline_id}')">
                            View Full Report
                        </button>
                    </div>
                `;
                
                // Mark all steps as completed
                document.querySelectorAll('.viz-step').forEach(step => {
                    step.classList.remove('active');
                    step.classList.add('completed');
                });
            }

            showPipelineWarning(result) {
                const statusDiv = document.getElementById('current-pipeline-status');
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>‚ö†Ô∏è Pipeline Completed with Warnings</h4>
                        <p><strong>Pipeline ID:</strong> ${result.pipeline_id}</p>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p>Some components may have encountered issues. Check the detailed report for more information.</p>
                    </div>
                `;
            }

            showPipelineError(error) {
                const statusDiv = document.getElementById('current-pipeline-status');
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Pipeline Execution Failed</h4>
                        <p>${error}</p>
                    </div>
                `;
                
                document.getElementById('pipeline-visualization').style.display = 'none';
            }

            animatePipelineSteps() {
                const steps = ['topic-researcher', 'rss-librarian', 'feed-fetcher', 'content-classifier', 'report-builder'];
                let currentStep = 0;

                const animateNext = () => {
                    if (currentStep > 0) {
                        document.getElementById(`step-${steps[currentStep - 1]}`).classList.remove('active');
                        document.getElementById(`step-${steps[currentStep - 1]}`).classList.add('completed');
                    }
                    
                    if (currentStep < steps.length) {
                        document.getElementById(`step-${steps[currentStep]}`).classList.add('active');
                        currentStep++;
                        setTimeout(animateNext, 1000);
                    }
                };

                // Reset all steps
                document.querySelectorAll('.viz-step').forEach(step => {
                    step.classList.remove('active', 'completed', 'failed');
                });

                // Start animation
                setTimeout(animateNext, 500);
            }

            async viewPipelineDetails(pipelineId) {
                try {
                    const details = await this.apiClient.callWorker('orchestrator', `/pipeline/${pipelineId}`);
                    
                    // For now, just show an alert with basic info
                    // In production, this would open a detailed modal or new page
                    alert(`Pipeline Details:\nID: ${pipelineId}\nStatus: ${details.status || 'Unknown'}\n\nFull pipeline viewer coming soon!`);
                    
                } catch (error) {
                    alert(`Failed to load pipeline details: ${error.message}`);
                }
            }

            filterPipelineHistory() {
                // Implementation for filtering pipeline history
                // This would filter the displayed results based on status and strategy
                console.log('Filtering pipeline history...');
            }

            startRefreshIntervals() {
                // Refresh system health every 30 seconds
                this.refreshInterval = setInterval(() => {
                    this.updateSystemHealth();
                    
                    // Refresh tab-specific data if needed
                    if (this.activeTab === 'monitoring') {
                        this.loadMonitoringData();
                    }
                }, 30000);
            }

            stopRefreshIntervals() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.orchestratorDashboard = new OrchestratorDashboard();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.orchestratorDashboard) {
                window.orchestratorDashboard.stopRefreshIntervals();
            }
        });
    </script>
</body>
</html>