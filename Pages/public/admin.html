<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory Admin</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link rel="stylesheet" href="/css/admin-modern.css">
    <link rel="stylesheet" href="/css/components/client-detail.css">
</head>
<body>
    <div id="app-container">
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner">üîÑ</div>
            <p>Loading AI Factory...</p>
        </div>
    </div>

    <!-- Core Scripts in Correct Order -->
    <script src="/js/shared/auth.js"></script>
    <!-- Removed old api.js - using new api-client.js instead -->
    <script src="/js/shared/ui.js"></script>
    <script src="/js/core/session-manager.js"></script>
    <script src="/js/core/api-client.js"></script>
    <script src="/js/core/kam-context-manager.js"></script>
    <script src="/js/core/permission-resolver.js"></script>
    <script src="/js/core/kam-router.js"></script>
    <script src="/js/components/ui-components.js"></script>
    <script src="/js/components/ai-factory-layout.js"></script>
    <script src="/js/components/clients-page.js"></script>
    <script src="/js/components/client-detail-page.js"></script>
    <script src="/js/components/dashboard-page.js"></script>
    <script src="/js/components/users-page.js"></script>
    <script src="/js/components/permissions-display.js"></script>

    <script>
        // SIMPLE initialization - no complex timeout logic
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');
            
            try {
                console.log('üöÄ Initializing AI Factory Admin...');
                
                // Step 1: Initialize authentication
                if (!window.authClient) {
                    throw new Error('Authentication client not loaded');
                }
                
                // Step 2: Check if user is already logged in
                const isLoggedIn = window.authClient.isAuthenticated();
                if (!isLoggedIn) {
                    console.log('üîê User not authenticated, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }
                
                // Step 3: Initialize session manager
                if (window.SessionManager && window.apiClient) {
                    window.sessionManager = new SessionManager(window.apiClient);
                    await window.sessionManager.validateSession();
                }
                
                // Step 4: Initialize layout first (before router)
                if (window.AIFactoryLayout) {
                    const userType = window.sessionManager?.getUserType() || 'admin';
                    console.log(`üé≠ Initializing layout for user type: ${userType}`);
                    
                    window.aiFactoryLayout = new AIFactoryLayout({
                        userType: userType,
                        user: window.sessionManager?.sessionData?.user
                    });
                    
                    appContainer.innerHTML = window.aiFactoryLayout.render();
                    await window.aiFactoryLayout.mount();
                }
                
                // Step 5: Initialize router after layout is ready
                if (window.KAMRouter) {
                    window.router = new KAMRouter();
                    await window.router.initialize();
                }
                
                // Hide loading screen
                loadingScreen.style.display = 'none';
                
                console.log('‚úÖ AI Factory Admin initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                
                // Simple error display - no complex fallbacks
                appContainer.innerHTML = `
                    <div class="error-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üí•</div>
                        <h2 style="color: #ef4444; margin-bottom: 1rem;">Initialization Error</h2>
                        <p style="color: #6b7280; margin-bottom: 2rem; max-width: 400px;">${error.message}</p>
                        <button onclick="window.location.reload()" 
                                style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                            üîÑ Reload Page
                        </button>
                    </div>
                `;
                
                loadingScreen.style.display = 'none';
            }
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('‚ùå Global error:', event.error);
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>