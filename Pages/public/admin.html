<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory Admin</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link rel="stylesheet" href="/css/admin-modern.css">
</head>
<body>
    <div id="app-container">
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner">üîÑ</div>
            <p>Initializing AI Factory...</p>
        </div>
    </div>

    <!-- Keep existing proven scripts -->
    <script src="/js/shared/auth.js"></script>
    <script src="/js/shared/api.js"></script>
    <script src="/js/core/api-client.js"></script>
    <script src="/js/core/session-manager.js"></script>
    <script src="/js/core/kam-context-manager.js"></script>
    <script src="/js/components/ui-components.js"></script>
    <script src="/js/components/enhanced-universal-researcher-card.js"></script>
    <script src="/js/components/client-list-manager.js"></script>    
    <script src="/js/admin-components.js"></script>

    <!-- NEW: Enhanced layout components (optional) -->
    <script src="/js/components/ai-factory-layout.js"></script>
    <script src="/js/components/clients-page.js"></script>

    <script>
        // ENHANCED: Safe integration with fallback to working dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');
            
            try {
                console.log('üöÄ Starting AI Factory Admin (Enhanced Version)...');
                
                // STEP 1: Authentication Check (unchanged)
                const sessionToken = localStorage.getItem('bitware-session-token');
                const userInfo = localStorage.getItem('bitware-user-info');
                
                if (!sessionToken || !userInfo) {
                    console.log('‚ùå No valid session, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }

                let user;
                try {
                    user = JSON.parse(userInfo);
                } catch (e) {
                    console.log('‚ùå Invalid user info, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }

                console.log('‚úÖ Authentication confirmed for:', user.email || user.username);
                // Debug Admin vs User Authentication
                // Add this to your admin.html script section temporarily to see the differences

                // ADD THIS RIGHT AFTER THE USER PARSING IN YOUR ADMIN.HTML:

                console.log('üîç DEBUG: Authentication Analysis');
                console.log('Raw userInfo string:', userInfo);
                console.log('Parsed user object:', user);
                console.log('User object keys:', Object.keys(user));
                console.log('User.role:', user.role);
                console.log('User.userType:', user.userType);
                console.log('User.email:', user.email);
                console.log('User.username:', user.username);
                console.log('User properties:');
                Object.entries(user).forEach(([key, value]) => {
                    console.log(`  ${key}:`, value);
                });

                // Test the determineUserType function
                const detectedUserType = determineUserType(user);
                console.log('üéØ Detected user type:', detectedUserType);

                // Test each condition individually
                console.log('üîç User type detection analysis:');
                console.log('  user.role === "admin":', user.role === 'admin');
                console.log('  user.userType === "admin":', user.userType === 'admin');
                console.log('  user.userType === "internal":', user.userType === 'internal');
                console.log('  user.email?.includes("@admin"):', user.email?.includes('@admin'));
                console.log('  user.isAdmin === true:', user.isAdmin === true);

                // Also check what happens in different scenarios
                if (detectedUserType === 'admin') {
                    console.log('‚úÖ Should use admin layout');
                } else {
                    console.log('‚ùå Will use client layout (this might be the problem for admin users)');
                }

                console.log('üîç End authentication debug');                
                // STEP 2: Initialize API Client (unchanged)
                if (!window.apiClient) {
                    window.apiClient = new AIFactoryAPIClient();
                    console.log('‚úÖ API Client initialized');
                }

                // STEP 3: Initialize KAM Context (unchanged, non-blocking)
                try {
                    if (window.KAMContextManager && !window.kamContext) {
                        window.kamContext = new KAMContextManager(window.apiClient);
                        const initialized = await window.kamContext.initialize();
                        console.log(initialized ? '‚úÖ KAM Context initialized' : '‚ö†Ô∏è KAM Context fallback mode');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è KAM Context failed (continuing):', error);
                }

                // STEP 4: Try Enhanced Layout First
                let enhancedLayoutSuccess = false;
                
                if (window.AIFactoryLayout) {
                    try {
                        console.log('üé® Attempting enhanced layout...');
                        
                        // Determine user type for layout
                        const userType = determineUserType(user);
                        
                        // Create enhanced layout
                        const layout = new AIFactoryLayout({
                            userType: userType,
                            user: user,
                            onNavigate: handleEnhancedNavigation,
                            showSearch: true
                        });

                        // Render enhanced layout
                        appContainer.innerHTML = layout.render();
                        await layout.mount();
                        
                        // Set global references
                        window.aiFactoryLayout = layout;
                        window.currentLayout = 'enhanced';
                        
                        // Load initial dashboard content
                        await loadDashboardInEnhancedLayout();
                        
                        enhancedLayoutSuccess = true;
                        console.log('‚úÖ Enhanced layout activated');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Enhanced layout failed:', error);
                        enhancedLayoutSuccess = false;
                    }
                }

                // STEP 5: Fallback to Working Dashboard
                if (!enhancedLayoutSuccess) {
                    console.log('üìä Using standard dashboard layout');
                    await initializeStandardDashboard();
                }

                // Hide loading screen
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }

                console.log('‚úÖ AI Factory Admin initialized successfully');

            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showErrorScreen(error.message);
            }
        });

        // ENHANCED: Determine user type from user info
        function determineUserType(user) {
            if (user.role === 'admin' || 
                user.userType === 'admin' || 
                user.userType === 'internal' ||
                user.email?.includes('@admin') ||
                user.isAdmin === true) {
                return 'admin';
            }
            return 'client';
        }

        // ENHANCED: Handle navigation in enhanced layout
        async function handleEnhancedNavigation(path) {
            console.log('üß≠ Enhanced navigation to:', path);
            
            const contentArea = document.getElementById('main-content');
            if (!contentArea) return;

            // Show loading state
            contentArea.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner">üîÑ</div>
                    <p>Loading ${path}...</p>
                </div>
            `;

            try {
                switch (path) {
                    case '/dashboard':
                        await loadDashboardInEnhancedLayout();
                        break;
                    case '/clients':
                        await loadClientsInEnhancedLayout();
                        break;
                    case '/reports':
                        loadPlaceholderContent('üìã Reports', 'Reports functionality coming soon!');
                        break;
                    case '/workers/universal-researcher':
                        loadPlaceholderContent('üîç Universal Researcher', 'Worker interface coming soon!');
                        break;
                    default:
                        loadPlaceholderContent('üöß Coming Soon', `${path} functionality will be available soon.`);
                }
            } catch (error) {
                console.error('Navigation error:', error);
                contentArea.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <h2>Navigation Error</h2>
                        <p>Failed to load ${path}</p>
                        <button class="btn btn-primary" onclick="aiFactoryLayout.navigate('/dashboard')">
                            Return to Dashboard
                        </button>
                    </div>
                `;
            }
        }

        // REPLACE THIS FUNCTION in your admin.html:
        async function loadDashboardInEnhancedLayout() {
            const contentArea = document.getElementById('main-content');
            if (!contentArea) return;

            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üìä Admin Dashboard</h1>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="refreshEnhancedDashboard()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                
                <div id="dashboard-content-area">
                    <div class="loading-state">
                        <div class="loading-spinner">üîÑ</div>
                        <p>Loading dashboard components...</p>
                    </div>
                </div>
            `;

            // Load ONLY the dashboard content, not the full dashboard
            setTimeout(async () => {
                try {
                    console.log('üîß Loading dashboard content (content only, no header)...');
                    
                    const contentWrapper = document.getElementById('dashboard-content-area');
                    if (!contentWrapper) return;

                    // Create dashboard content without the full dashboard wrapper
                    if (window.AdminDashboard && !window.adminDashboard) {
                        window.adminDashboard = new AdminDashboard();
                    }

                    if (window.adminDashboard) {
                        // Instead of loading full dashboard, create just the content part
                        const dashboardContentHTML = await createDashboardContentOnly();
                        contentWrapper.innerHTML = dashboardContentHTML;
                        
                        // Load stats and initialize components
                        await loadDashboardStats();
                        
                        console.log('‚úÖ Dashboard content loaded (without duplicate header)');
                    } else {
                        // Fallback: create basic content
                        contentWrapper.innerHTML = createBasicDashboardContent();
                    }
                } catch (error) {
                    console.warn('Failed to load dashboard content:', error);
                    const contentWrapper = document.getElementById('dashboard-content-area');
                    if (contentWrapper) {
                        contentWrapper.innerHTML = createBasicDashboardContent();
                    }
                }
            }, 100);
        }
        // ENHANCED: Load clients in enhanced layout
        async function loadClientsInEnhancedLayout() {
            const contentArea = document.getElementById('main-content');
            if (!contentArea) return;

            if (window.ClientsPage) {
                try {
                    console.log('üìã Loading enhanced clients page...');
                    const clientsPage = new ClientsPage(window.apiClient);
                    contentArea.innerHTML = await clientsPage.render();
                    await clientsPage.mount();
                    
                    console.log('‚úÖ Enhanced clients page loaded');
                } catch (error) {
                    console.warn('Failed to load ClientsPage:', error);
                    loadFallbackClientsContent();
                }
            } else {
                loadFallbackClientsContent();
            }
        }

        // NEW FUNCTION: Create only dashboard content (no header/wrapper)
        async function createDashboardContentOnly() {
            return `
                <!-- Stats Grid -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="enhanced-clients-count">-</div>
                        <div class="stat-label">Total Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="enhanced-revenue-count">-</div>
                        <div class="stat-label">Monthly Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="enhanced-requests-count">-</div>
                        <div class="stat-label">Requests Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="enhanced-health-status">-</div>
                        <div class="stat-label">System Health</div>
                    </div>
                </div>
                
                <!-- Dashboard Action Cards -->
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üë• Client Management</h3>
                        </div>
                        <div class="card-content">
                            <p>Manage client accounts and view detailed information with expandable rows.</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn-primary" onclick="aiFactoryLayout.navigate('/clients')">
                                    üìã View Clients (Enhanced)
                                </button>
                                <button class="btn-secondary" style="margin-left: 0.5rem;" onclick="showClients()">
                                    üìù Classic Modal
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üîß AI Workers</h3>
                        </div>
                        <div class="card-content">
                            <p>Monitor and manage AI worker health and performance.</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn-primary" onclick="aiFactoryLayout.navigate('/workers/universal-researcher')">
                                    üîç Universal Researcher
                                </button>
                                <button class="btn-secondary" style="margin-left: 0.5rem;" onclick="checkWorkerHealth()">
                                    ‚ö° Check Health
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìä Analytics & Reports</h3>
                        </div>
                        <div class="card-content">
                            <p>View system analytics, usage reports, and insights.</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn-primary" onclick="aiFactoryLayout.navigate('/reports')">
                                    üìä View Reports
                                </button>
                                <button class="btn-secondary" style="margin-left: 0.5rem;" onclick="aiFactoryLayout.navigate('/analytics')">
                                    üìà Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è System Management</h3>
                        </div>
                        <div class="card-content">
                            <p>Configure system settings and monitor performance.</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn-primary" onclick="aiFactoryLayout.navigate('/settings')">
                                    ‚öôÔ∏è Settings
                                </button>
                                <button class="btn-secondary" style="margin-left: 0.5rem;" onclick="aiFactoryLayout.navigate('/billing')">
                                    üí≥ Billing
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Universal Researcher Card -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">üîç Quick Research</h3>
                    </div>
                    <div class="card-content">
                        <div id="enhanced-universal-researcher-container">
                            <div class="loading-state">
                                <div class="loading-spinner">üîÑ</div>
                                <p>Loading Universal Researcher...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // NEW FUNCTION: Load dashboard stats for enhanced layout
        async function loadDashboardStats() {
            try {
                console.log('üìä Loading enhanced dashboard stats...');
                
                // Try to load real stats from existing admin dashboard
                if (window.adminDashboard && typeof window.adminDashboard.loadStats === 'function') {
                    // If the admin dashboard has a loadStats method, use it
                    const stats = await window.adminDashboard.loadStats();
                    if (stats) {
                        updateEnhancedStats(stats);
                        return;
                    }
                }
                
                // Try to load from API
                if (window.apiClient && typeof window.apiClient.getSystemStats === 'function') {
                    const stats = await window.apiClient.getSystemStats();
                    updateEnhancedStats(stats);
                    return;
                }
                
                // Fallback: Load mock stats
                updateEnhancedStats({
                    clients: 3,
                    revenue: 1250,
                    requests: 47,
                    health: 'Good'
                });
                
                console.log('‚úÖ Enhanced dashboard stats loaded');
                
            } catch (error) {
                console.warn('Failed to load dashboard stats:', error);
                updateEnhancedStats({
                    clients: '-',
                    revenue: '-',
                    requests: '-',
                    health: 'Unknown'
                });
            }
            
            // Load Enhanced Universal Researcher
            setTimeout(() => {
                loadEnhancedUniversalResearcher();
            }, 500);
        }

        // NEW FUNCTION: Update stats in enhanced layout
        function updateEnhancedStats(stats) {
            const elements = {
                'enhanced-clients-count': stats.clients || '-',
                'enhanced-revenue-count': stats.revenue ? `$${stats.revenue}` : '-',
                'enhanced-requests-count': stats.requests || '-',
                'enhanced-health-status': stats.health === 'Good' ? '‚úÖ Good' : (stats.health || '‚ö†Ô∏è Unknown')
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        // NEW FUNCTION: Load Enhanced Universal Researcher in dashboard
        function loadEnhancedUniversalResearcher() {
            const container = document.getElementById('enhanced-universal-researcher-container');
            if (!container) return;
            
            try {
                if (window.EnhancedUniversalResearcherCard) {
                    console.log('üîç Loading Enhanced Universal Researcher in dashboard...');
                    
                    const researcherCard = new EnhancedUniversalResearcherCard({
                        apiClient: window.apiClient,
                        userContext: {
                            userType: 'admin',
                            permissions: ['worker_access', 'admin_access']
                        },
                        containerId: 'enhanced-universal-researcher-container'
                    });
                    
                    researcherCard.mount();
                    console.log('‚úÖ Enhanced Universal Researcher loaded in dashboard');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                            <p>Enhanced Universal Researcher component not available</p>
                            <button class="btn btn-secondary btn-sm" onclick="aiFactoryLayout.navigate('/workers/universal-researcher')">
                                Open Researcher
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.warn('Failed to load Enhanced Universal Researcher:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                        <p>Research component loading...</p>
                    </div>
                `;
            }
        }
        // ENHANCED: Fallback clients content
        function loadFallbackClientsContent() {
            const contentArea = document.getElementById('main-content');
            if (!contentArea) return;

            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üë• Client Management</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="showClients()">
                            Open Client List
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                    <h2>Client Management</h2>
                    <p>Enhanced client page with expandable rows is loading...</p>
                    <p style="color: var(--text-secondary); margin-top: 1rem;">
                        You can use the "Open Client List" button above to access the existing client management modal.
                    </p>
                </div>
            `;
        }

        // ENHANCED: Load placeholder content
        function loadPlaceholderContent(title, message) {
            const contentArea = document.getElementById('main-content');
            if (!contentArea) return;

            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">${title}</h1>
                </div>
                
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üöß</div>
                    <h2>Coming Soon</h2>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="aiFactoryLayout.navigate('/dashboard')">
                        Return to Dashboard
                    </button>
                </div>
            `;
        }

        // STANDARD: Initialize standard dashboard (fallback)
        async function initializeStandardDashboard() {
            try {
                if (window.AdminDashboard) {
                    if (!window.adminDashboard) {
                        window.adminDashboard = new AdminDashboard();
                    }
                    
                    // Try different initialization approaches
                    if (typeof window.adminDashboard.initialize === 'function') {
                        await window.adminDashboard.initialize();
                    } else if (typeof window.adminDashboard.render === 'function') {
                        const content = await window.adminDashboard.render();
                        document.getElementById('app-container').innerHTML = content;
                        
                        if (typeof window.adminDashboard.mount === 'function') {
                            await window.adminDashboard.mount();
                        }
                    } else {
                        showWorkingAdminDashboard();
                    }
                } else {
                    showWorkingAdminDashboard();
                }
                
                window.currentLayout = 'standard';
                console.log('‚úÖ Standard dashboard initialized');
                
            } catch (error) {
                console.error('Standard dashboard failed:', error);
                showWorkingAdminDashboard();
            }
        }

        // STANDARD: Working admin dashboard (proven fallback)
        function showWorkingAdminDashboard() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;
            
            appContainer.innerHTML = `
                <div class="admin-dashboard">
                    <header class="dashboard-header">
                        <h1>üéõÔ∏è AI Factory Admin</h1>
                        <div class="header-actions">
                            <button class="btn-secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
                            <button class="btn-secondary" onclick="logout()">üö™ Logout</button>
                        </div>
                    </header>
                    
                    <div class="dashboard-content">
                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="clients-count">-</div>
                                <div class="stat-label">Total Clients</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="revenue-count">-</div>
                                <div class="stat-label">Monthly Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="requests-count">-</div>
                                <div class="stat-label">Requests Today</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="health-status">-</div>
                                <div class="stat-label">System Health</div>
                            </div>
                        </div>
                        
                        <!-- Action Cards -->
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üë• Client Management</h3>
                                </div>
                                <div class="card-content">
                                    <p>Manage client accounts, subscriptions, and settings.</p>
                                    <div style="margin-top: 1rem;">
                                        <button class="btn-primary" onclick="showClients()">View Clients</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üîß AI Workers</h3>
                                </div>
                                <div class="card-content">
                                    <p>Monitor and manage AI worker health and performance.</p>
                                    <div style="margin-top: 1rem;">
                                        <button class="btn-primary" onclick="checkWorkerHealth()">Check Health</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">üé® Try Enhanced Layout</h3>
                                </div>
                                <div class="card-content">
                                    <p>Experience the new sidebar + topbar interface.</p>
                                    <div style="margin-top: 1rem;">
                                        <button class="btn-primary" onclick="tryEnhancedLayout()">Switch to Enhanced</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            window.currentLayout = 'standard';
            loadBasicStats();
        }

        // UTILITY: Create basic dashboard content
        function createBasicDashboardContent() {
            return `
                <div class="basic-dashboard-content">
                    <!-- Stats Grid -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-value">3</div>
                            <div class="stat-label">Total Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$1,250</div>
                            <div class="stat-label">Monthly Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">47</div>
                            <div class="stat-label">Requests Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">‚úÖ Good</div>
                            <div class="stat-label">System Health</div>
                        </div>
                    </div>
                    
                    <!-- Action Cards -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üë• Client Management</h3>
                            </div>
                            <div class="card-content">
                                <p>Manage client accounts and view detailed information.</p>
                                <button class="btn-primary" onclick="showClients()">View Clients</button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üîß System Status</h3>
                            </div>
                            <div class="card-content">
                                <p>Monitor AI workers and system performance.</p>
                                <button class="btn-primary" onclick="checkWorkerHealth()">Check Status</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // UTILITY: Global functions
        window.logout = function() {
            localStorage.removeItem('bitware-session-token');
            localStorage.removeItem('bitware-user-info');
            localStorage.removeItem('bitware-kam-context');
            window.location.href = '/login.html';
        };

        window.refreshDashboard = function() {
            window.location.reload();
        };

        window.refreshEnhancedDashboard = function() {
            if (window.aiFactoryLayout) {
                loadDashboardInEnhancedLayout();
            } else {
                window.location.reload();
            }
        };

        window.showClients = function() {
            if (window.currentLayout === 'enhanced' && window.aiFactoryLayout) {
                window.aiFactoryLayout.navigate('/clients');
            } else {
                // Use existing modal
                if (window.ClientListManager) {
                    const clientManager = new ClientListManager(window.apiClient);
                    clientManager.show();
                } else {
                    alert('Client management functionality is loading...');
                }
            }
        };

        window.checkWorkerHealth = function() {
            alert('AI Worker health check functionality coming soon!');
        };

        window.tryEnhancedLayout = function() {
            alert('Refreshing to try enhanced layout...');
            window.location.reload();
        };

        window.loadBasicStats = function() {
            // Load basic stats for standard dashboard
            setTimeout(() => {
                try {
                    if (document.getElementById('clients-count')) {
                        document.getElementById('clients-count').textContent = '3';
                        document.getElementById('revenue-count').textContent = '$1,250';
                        document.getElementById('requests-count').textContent = '47';
                        document.getElementById('health-status').textContent = '‚úÖ Good';
                    }
                } catch (error) {
                    console.warn('Failed to load basic stats:', error);
                }
            }, 100);
        };

        function showErrorScreen(message) {
            const appContainer = document.getElementById('app-container');
            if (appContainer) {
                appContainer.innerHTML = `
                    <div class="error-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üí•</div>
                        <h2>Initialization Error</h2>
                        <p>Failed to initialize: ${message}</p>
                        <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Reload Page
                        </button>
                    </div>
                `;
            }
            
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }
    </script>
</body>
</html>