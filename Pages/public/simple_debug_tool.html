<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Simple Health Check Debugger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .section:last-child {
            border-bottom: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); }
        .btn-warning { background: linear-gradient(45deg, #ffc107, #ff8f00); color: #212529; }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #c82333); }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .status-unknown { background: #6c757d; color: white; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-testing { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .test-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .test-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .step-by-step {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin-top: 20px;
        }

        .step {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .step-number {
            display: inline-block;
            background: #007bff;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: 600;
            font-size: 12px;
            margin-right: 10px;
        }

        .command-box {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Simple Health Check Debugger</h1>
            <p>Let's find out exactly why your health check is failing</p>
        </div>

        <!-- Configuration -->
        <div class="section">
            <h2>üìù Configuration</h2>
            
            <div class="input-group">
                <label>Your Pages Domain:</label>
                <input type="text" id="pagesDomain" value="https://ai-factory-frontend.pages.dev" placeholder="https://your-domain.pages.dev">
            </div>
            
            <div class="input-group">
                <label>Orchestrator Worker URL (if you know it):</label>
                <input type="text" id="workerUrl" placeholder="https://bitware-orchestrator.yourname.workers.dev">
            </div>
            
            <button class="btn btn-success" onclick="runStepByStepDebug()">üöÄ Debug Step by Step</button>
            <button class="btn btn-warning" onclick="runQuickTests()">‚ö° Quick Tests</button>
            <button class="btn" onclick="clearResults()">üóëÔ∏è Clear</button>
        </div>

        <!-- Status -->
        <div class="section">
            <h2>üìä Current Status</h2>
            <div class="status-indicator status-unknown" id="overallStatus">Ready to test</div>
            <div class="result-box" id="statusDetails">Click "Debug Step by Step" to start...</div>
        </div>

        <!-- Tests -->
        <div class="section">
            <h2>üß™ Individual Tests</h2>
            
            <div class="test-grid">
                <div class="test-item">
                    <div class="test-title">1. Pages Deployment</div>
                    <div class="status-indicator status-unknown" id="pagesStatus">Unknown</div>
                    <br><br>
                    <button class="btn" onclick="testPagesDeployment()">Test Pages</button>
                </div>
                
                <div class="test-item">
                    <div class="test-title">2. Pages Functions</div>
                    <div class="status-indicator status-unknown" id="functionsStatus">Unknown</div>
                    <br><br>
                    <button class="btn" onclick="testPagesFunctions()">Test Functions</button>
                </div>
                
                <div class="test-item">
                    <div class="test-title">3. Orchestrator Proxy</div>
                    <div class="status-indicator status-unknown" id="proxyStatus">Unknown</div>
                    <br><br>
                    <button class="btn" onclick="testOrchestratorProxy()">Test Proxy</button>
                </div>
                
                <div class="test-item">
                    <div class="test-title">4. Direct Worker</div>
                    <div class="status-indicator status-unknown" id="workerStatus">Unknown</div>
                    <br><br>
                    <button class="btn" onclick="testDirectWorker()">Test Direct</button>
                </div>
            </div>
        </div>

        <!-- Step by Step Guide -->
        <div class="section">
            <h2>üõ†Ô∏è Step-by-Step Troubleshooting</h2>
            
            <div class="step-by-step">
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Check if your Pages deployment exists:</strong>
                    <div class="command-box">wrangler pages deployment list --project-name=ai-factory-frontend</div>
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Verify your actual Pages domain:</strong>
                    <div class="command-box">
# Check your Pages dashboard at:<br>
# https://dash.cloudflare.com/?to=/:account/pages
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Check if orchestrator worker is deployed:</strong>
                    <div class="command-box">
# Go to orchestrator directory and deploy:<br>
cd workers/bitware_orchestrator<br>
wrangler deploy
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Test orchestrator directly (bypass Pages):</strong>
                    <div class="command-box">curl https://bitware-orchestrator.YOUR-SUBDOMAIN.workers.dev/health</div>
                </div>
                
                <div class="step">
                    <span class="step-number">5</span>
                    <strong>Check your wrangler.toml has correct URLs:</strong>
                    <div class="command-box">
# In your Pages project wrangler.toml:<br>
[env.production]<br>
ORCHESTRATOR_URL = "https://bitware-orchestrator.YOUR-SUBDOMAIN.workers.dev"
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="section">
            <h2>üìã Debug Results</h2>
            <div class="result-box" id="debugResults">Debug results will appear here...</div>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const resultsDiv = document.getElementById('debugResults');
            resultsDiv.textContent = debugLog.join('\n');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            // Also update status details
            const statusDetails = document.getElementById('statusDetails');
            statusDetails.textContent = debugLog.slice(-3).join('\n');
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
            element.textContent = text;
        }

        async function runStepByStepDebug() {
            clearResults();
            log('üîç Starting step-by-step debug...');
            updateStatus('overallStatus', 'testing', 'Running diagnostics...');
            
            // Step 1: Test Pages deployment
            log('\n--- STEP 1: Testing Pages deployment ---');
            await testPagesDeployment();
            
            // Step 2: Test Pages Functions
            log('\n--- STEP 2: Testing Pages Functions ---');
            await testPagesFunctions();
            
            // Step 3: Test orchestrator proxy
            log('\n--- STEP 3: Testing orchestrator proxy ---');
            await testOrchestratorProxy();
            
            // Step 4: Test direct worker (if URL provided)
            const workerUrl = document.getElementById('workerUrl').value;
            if (workerUrl) {
                log('\n--- STEP 4: Testing direct worker ---');
                await testDirectWorker();
            } else {
                log('\n--- STEP 4: Skipped (no worker URL provided) ---');
            }
            
            // Generate summary
            generateDebugSummary();
        }

        async function testPagesDeployment() {
            const pagesDomain = document.getElementById('pagesDomain').value;
            
            updateStatus('pagesStatus', 'testing', 'Testing...');
            log('Testing Pages deployment accessibility...');
            
            try {
                const response = await fetch(pagesDomain, { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    updateStatus('pagesStatus', 'success', 'Pages Online');
                    log(`‚úÖ Pages deployment accessible (HTTP ${response.status})`);
                    return true;
                } else {
                    updateStatus('pagesStatus', 'error', `HTTP ${response.status}`);
                    log(`‚ùå Pages deployment error: HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                updateStatus('pagesStatus', 'error', 'Connection failed');
                log(`‚ùå Pages deployment failed: ${error.message}`);
                log('üí° This usually means: Domain is wrong, deployment failed, or DNS issues');
                return false;
            }
        }

        async function testPagesFunctions() {
            const pagesDomain = document.getElementById('pagesDomain').value;
            
            updateStatus('functionsStatus', 'testing', 'Testing...');
            log('Testing Pages Functions...');
            
            try {
                // Try to call a non-existent function to see if Functions are working
                const response = await fetch(`${pagesDomain}/api/test-function`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true }),
                    cache: 'no-cache'
                });
                
                // Any response (even 404) means Functions are working
                if (response.status === 404) {
                    updateStatus('functionsStatus', 'success', 'Functions Work');
                    log('‚úÖ Pages Functions are responding (got expected 404)');
                    return true;
                } else if (response.status >= 200 && response.status < 500) {
                    updateStatus('functionsStatus', 'success', 'Functions Work');
                    log(`‚úÖ Pages Functions responding (HTTP ${response.status})`);
                    return true;
                } else {
                    updateStatus('functionsStatus', 'error', `HTTP ${response.status}`);
                    log(`‚ùå Pages Functions error: HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                updateStatus('functionsStatus', 'error', 'Functions broken');
                log(`‚ùå Pages Functions failed: ${error.message}`);
                log('üí° This usually means: Functions not deployed, wrangler.toml issues, or build failed');
                return false;
            }
        }

        async function testOrchestratorProxy() {
            const pagesDomain = document.getElementById('pagesDomain').value;
            
            updateStatus('proxyStatus', 'testing', 'Testing...');
            log('Testing orchestrator proxy...');
            
            try {
                const response = await fetch(`${pagesDomain}/api/orchestrator`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint: '/health',
                        method: 'GET'
                    }),
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                log(`Proxy response: ${response.status} - ${responseText.substring(0, 200)}`);
                
                if (response.ok) {
                    updateStatus('proxyStatus', 'success', 'Proxy Works');
                    log('‚úÖ Orchestrator proxy working!');
                    return true;
                } else if (response.status === 500) {
                    updateStatus('proxyStatus', 'error', 'Worker unreachable');
                    log('‚ùå Proxy gets 500 - worker URL is probably wrong or worker not deployed');
                    log('üí° Check: ORCHESTRATOR_URL in wrangler.toml and worker deployment');
                    return false;
                } else if (response.status === 404) {
                    updateStatus('proxyStatus', 'error', 'Proxy not found');
                    log('‚ùå Orchestrator proxy not found - /api/orchestrator.js missing');
                    log('üí° Check: functions/api/orchestrator.js file exists and deployed');
                    return false;
                } else {
                    updateStatus('proxyStatus', 'error', `HTTP ${response.status}`);
                    log(`‚ùå Orchestrator proxy error: HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                updateStatus('proxyStatus', 'error', 'Proxy failed');
                log(`‚ùå Orchestrator proxy failed: ${error.message}`);
                return false;
            }
        }

        async function testDirectWorker() {
            const workerUrl = document.getElementById('workerUrl').value;
            
            if (!workerUrl) {
                updateStatus('workerStatus', 'error', 'No URL provided');
                log('‚ùå No worker URL provided');
                return false;
            }
            
            updateStatus('workerStatus', 'testing', 'Testing...');
            log(`Testing direct worker at: ${workerUrl}`);
            
            try {
                const healthUrl = `${workerUrl}/health`;
                const response = await fetch(healthUrl, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                const responseText = await response.text();
                log(`Direct worker response: ${response.status} - ${responseText.substring(0, 200)}`);
                
                if (response.ok) {
                    updateStatus('workerStatus', 'success', 'Worker Online');
                    log('‚úÖ Direct worker accessible!');
                    return true;
                } else {
                    updateStatus('workerStatus', 'error', `HTTP ${response.status}`);
                    log(`‚ùå Direct worker error: HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                updateStatus('workerStatus', 'error', 'Worker unreachable');
                log(`‚ùå Direct worker failed: ${error.message}`);
                log('üí° This means: Worker not deployed, wrong URL, or worker has errors');
                return false;
            }
        }

        async function runQuickTests() {
            clearResults();
            log('‚ö° Running quick tests...');
            
            // Test in parallel
            const tests = [
                testPagesDeployment(),
                testOrchestratorProxy()
            ];
            
            await Promise.all(tests);
            generateDebugSummary();
        }

        function generateDebugSummary() {
            log('\n=== DEBUG SUMMARY ===');
            
            const pagesStatus = document.getElementById('pagesStatus').textContent;
            const functionsStatus = document.getElementById('functionsStatus').textContent;
            const proxyStatus = document.getElementById('proxyStatus').textContent;
            const workerStatus = document.getElementById('workerStatus').textContent;
            
            if (pagesStatus.includes('Online') && proxyStatus.includes('Works')) {
                updateStatus('overallStatus', 'success', 'System Working!');
                log('üéâ SUCCESS: Your health check should work now!');
            } else if (!pagesStatus.includes('Online')) {
                updateStatus('overallStatus', 'error', 'Pages deployment issue');
                log('üî¥ ISSUE: Pages deployment not accessible');
                log('üõ†Ô∏è  FIX: Check your domain and run: wrangler pages deploy public');
            } else if (!functionsStatus.includes('Work')) {
                updateStatus('overallStatus', 'error', 'Pages Functions issue');
                log('üî¥ ISSUE: Pages Functions not working');
                log('üõ†Ô∏è  FIX: Check wrangler.toml and redeploy Pages');
            } else if (!proxyStatus.includes('Works')) {
                updateStatus('overallStatus', 'error', 'Orchestrator proxy issue');
                log('üî¥ ISSUE: Orchestrator proxy not working');
                log('üõ†Ô∏è  FIX: Check ORCHESTRATOR_URL in wrangler.toml and deploy orchestrator worker');
            } else {
                updateStatus('overallStatus', 'error', 'Multiple issues');
                log('üî¥ ISSUE: Multiple problems detected');
                log('üõ†Ô∏è  FIX: Follow the step-by-step guide above');
            }
            
            log('\n=== NEXT STEPS ===');
            log('1. Fix the issues identified above');
            log('2. Re-run this debugger to verify fixes');
            log('3. Once all tests pass, try the orchestrator test page again');
        }

        function clearResults() {
            debugLog = [];
            document.getElementById('debugResults').textContent = 'Debug results will appear here...';
            document.getElementById('statusDetails').textContent = 'Click "Debug Step by Step" to start...';
            
            // Reset all status indicators
            updateStatus('overallStatus', 'unknown', 'Ready to test');
            updateStatus('pagesStatus', 'unknown', 'Unknown');
            updateStatus('functionsStatus', 'unknown', 'Unknown');
            updateStatus('proxyStatus', 'unknown', 'Unknown');
            updateStatus('workerStatus', 'unknown', 'Unknown');
        }

        // Auto-run on page load for production
        document.addEventListener('DOMContentLoaded', () => {
            const domain = document.getElementById('pagesDomain').value;
            if (domain.includes('pages.dev') || domain.includes('https://')) {
                setTimeout(() => {
                    log('üöÄ Auto-running quick test...');
                    runQuickTests();
                }, 1000);
            }
        });
    </script>
</body>
</html>