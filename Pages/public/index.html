<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .worker { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .online { background-color: green; }
        .offline { background-color: red; }
        .unknown { background-color: gray; }
        button { margin: 5px; padding: 10px; }
        #results { margin-top: 20px; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>AI Factory Dashboard</h1>
    
    <div>
        <button onclick="login()">Login</button>
        <button onclick="testHealth()">Test Health</button>
        <button onclick="testSingleWorker()">Test Orchestrator</button>
    </div>

    <h2>Workers</h2>
    <div id="workers">
        <div class="worker">
            <span class="status unknown" id="status-orchestrator"></span>
            <strong>Orchestrator</strong>
            <span id="orchestrator-info"></span>
        </div>
        <div class="worker">
            <span class="status unknown" id="status-topic-researcher"></span>
            <strong>Topic Researcher</strong>
            <span id="topic-researcher-info"></span>
        </div>
        <div class="worker">
            <span class="status unknown" id="status-rss-librarian"></span>
            <strong>RSS Librarian</strong>
            <span id="rss-librarian-info"></span>
        </div>
        <div class="worker">
            <span class="status unknown" id="status-feed-fetcher"></span>
            <strong>Feed Fetcher</strong>
            <span id="feed-fetcher-info"></span>
        </div>
        <div class="worker">
            <span class="status unknown" id="status-content-classifier"></span>
            <strong>Content Classifier</strong>
            <span id="content-classifier-info"></span>
        </div>
        <div class="worker">
            <span class="status unknown" id="status-report-builder"></span>
            <strong>Report Builder</strong>
            <span id="report-builder-info"></span>
        </div>
    </div>

    <div id="results"></div>

    <script>
        // Simple login
        async function login() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: '4B(HtyVinDuMl6]n5$]l' })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('token', data.sessionToken);
                    document.getElementById('results').textContent = 'Logged in successfully!';
                } else {
                    document.getElementById('results').textContent = 'Login failed: ' + data.error;
                }
            } catch (error) {
                document.getElementById('results').textContent = 'Login error: ' + error.message;
            }
        }

        // Test single worker
        async function testSingleWorker() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('results').textContent = 'Please login first';
                return;
            }

            try {
                const response = await fetch('/api/orchestrator?endpoint=/health', {
                    headers: { 'x-bitware-session-token': token }
                });
                const data = await response.json();
                document.getElementById('results').textContent = 'Orchestrator health: ' + JSON.stringify(data, null, 2);
                
                // Update status
                if (data.status === 'healthy') {
                    document.getElementById('status-orchestrator').className = 'status online';
                    document.getElementById('orchestrator-info').textContent = 'ONLINE';
                } else {
                    document.getElementById('status-orchestrator').className = 'status offline';
                    document.getElementById('orchestrator-info').textContent = 'OFFLINE';
                }
            } catch (error) {
                document.getElementById('results').textContent = 'Error: ' + error.message;
                document.getElementById('status-orchestrator').className = 'status offline';
                document.getElementById('orchestrator-info').textContent = 'ERROR';
            }
        }

        async function testHealth() {
    const token = localStorage.getItem('token');
    if (!token) {
        document.getElementById('results').textContent = 'Please login first';
        return;
    }

 // Complete testHealth function for the simple dashboard
async function testHealth() {
    const token = localStorage.getItem('token');
    if (!token) {
        document.getElementById('results').textContent = 'Please login first';
        return;
    }

    // Worker configurations - each worker may have different endpoints
    const workers = [
        { name: 'orchestrator', endpoint: '/health' },
        { name: 'topic-researcher', endpoint: '/health' },
        { name: 'rss-librarian', endpoint: '/health' },
        { name: 'feed-fetcher', endpoint: '/help' },  // Feed fetcher has no health endpoint, use /help
        { name: 'content-classifier', endpoint: '/health' },
        { name: 'report-builder', endpoint: '/health' }
    ];

    const results = {};
    let onlineCount = 0;

    document.getElementById('results').textContent = 'Testing workers...';

    for (const worker of workers) {
        try {
            console.log(`Testing ${worker.name} with endpoint ${worker.endpoint}`);
            
            const response = await fetch(`/api/${worker.name}?endpoint=${worker.endpoint}`, {
                headers: { 'x-bitware-session-token': token }
            });

            if (response.ok) {
                const data = await response.json();
                results[worker.name] = data;
                
                console.log(`${worker.name} response:`, data);
                
                // Check if worker is healthy (different workers may return different status formats)
                const isHealthy = data.status === 'healthy' || 
                                 data.status === 'operational' ||
                                 data.status === 'online' ||
                                 (data.feeds_processed !== undefined) || // Feed fetcher status format
                                 (data.worker === 'bitware_feed_fetcher'); // Feed fetcher /help response
                
                if (isHealthy) {
                    document.getElementById(`status-${worker.name}`).className = 'status online';
                    document.getElementById(`${worker.name}-info`).textContent = 'ONLINE';
                    onlineCount++;
                } else {
                    document.getElementById(`status-${worker.name}`).className = 'status offline';
                    document.getElementById(`${worker.name}-info`).textContent = 'OFFLINE';
                }
            } else {
                // Handle non-200 responses
                const errorText = await response.text();
                let errorData;
                try {
                    errorData = JSON.parse(errorText);
                } catch (e) {
                    errorData = { error: errorText || `HTTP ${response.status}` };
                }
                
                results[worker.name] = { 
                    status: 'error', 
                    error: errorData.error || `HTTP ${response.status}`,
                    http_status: response.status
                };
                
                document.getElementById(`status-${worker.name}`).className = 'status offline';
                document.getElementById(`${worker.name}-info`).textContent = `ERROR (${response.status})`;
                
                console.error(`${worker.name} error:`, errorData);
            }
        } catch (error) {
            // Handle network errors, timeouts, etc.
            results[worker.name] = { 
                status: 'error', 
                error: error.message,
                type: 'network_error'
            };
            
            document.getElementById(`status-${worker.name}`).className = 'status offline';
            document.getElementById(`${worker.name}-info`).textContent = 'NETWORK ERROR';
            
            console.error(`${worker.name} network error:`, error);
        }
    }

    // Update results display
    const resultText = `Workers Online: ${onlineCount}/6\n\nDetailed Results:\n${JSON.stringify(results, null, 2)}`;
    document.getElementById('results').textContent = resultText;
    
    // Summary
    console.log(`Health check complete: ${onlineCount}/6 workers online`);
    
    if (onlineCount === 6) {
        console.log('ðŸŽ‰ All workers online!');
    } else {
        console.log('âš ï¸ Some workers offline - check results for details');
    }
}
}
        // Auto-login on load for testing
        window.addEventListener('load', () => {
            login();
        });
    </script>
</body>
</html>