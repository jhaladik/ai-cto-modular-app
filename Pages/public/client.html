<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Factory</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link rel="stylesheet" href="/css/admin-modern.css">
    <style>
        /* Client-specific styling overrides */
        .upgrade-card {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .tier-limitations {
            margin-top: 0.5rem; 
            padding: 0.5rem; 
            background: #f3f4f6; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            color: #6b7280;
        }
        
        .report-item {
            padding: 1rem; 
            border: 1px solid #e5e7eb; 
            border-radius: 6px; 
            margin-bottom: 1rem;
            transition: box-shadow 0.2s ease;
        }
        
        .report-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header h1 {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .client-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #ddd6fe;
            color: #5b21b6;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner">üîÑ</div>
            <p>Loading your AI Factory dashboard...</p>
        </div>
    </div>

    <!-- Core Scripts - Keep existing order -->
    <script src="/js/shared/auth.js"></script>
    <script src="/js/shared/api.js"></script>
    <script src="/js/core/api-client.js"></script>
    <script src="/js/core/session-manager.js"></script>
    <script src="/js/core/kam-context-manager.js"></script>
    
    <!-- NEW: Add layout components but don't auto-initialize -->
    <script src="/js/components/ai-factory-layout.js"></script>
    <script src="/js/components/clients-page.js"></script>
    
    <!-- NEW: Load fixed router (no auto-init) -->
    <script src="/js/core/kam-router.js"></script>
    
    <!-- Existing Components -->
    <script src="/js/components/ui-components.js"></script>
    <script src="/js/components/enhanced-universal-researcher-card.js"></script>
    <script src="/js/dashboards/client-dashboard.js"></script>

    <script>
        // FIXED: Proper authentication flow for client dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');
            
            try {
                console.log('üöÄ Starting AI Factory Client Dashboard (Enhanced)...');
                
                // STEP 1: Authentication Check (existing logic preserved)
                const sessionToken = localStorage.getItem('bitware-session-token');
                const userInfo = localStorage.getItem('bitware-user-info');
                
                if (!sessionToken || !userInfo) {
                    console.log('‚ùå No valid session, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }

                let user;
                try {
                    user = JSON.parse(userInfo);
                } catch (e) {
                    console.log('‚ùå Invalid user info, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }

                console.log('‚úÖ Authentication confirmed for:', user.email || user.username);
                
                // STEP 2: Initialize API Client (existing logic)
                if (!window.apiClient) {
                    window.apiClient = new AIFactoryAPIClient();
                    console.log('‚úÖ API Client initialized');
                }

                // STEP 3: Initialize KAM Context (existing logic - but don't block on it)
                let kamContextInitialized = false;
                try {
                    if (window.KAMContextManager && !window.kamContext) {
                        window.kamContext = new KAMContextManager(window.apiClient);
                        kamContextInitialized = await window.kamContext.initialize();
                        console.log(kamContextInitialized ? '‚úÖ KAM Context initialized' : '‚ö†Ô∏è KAM Context fallback mode');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è KAM Context initialization failed (continuing anyway):', error);
                }

                // STEP 4: Try Enhanced Layout First, Fall Back to Original
                let layoutInitialized = false;
                
                if (window.AIFactoryLayout && window.initializeAIFactoryRouter) {
                    try {
                        console.log('üé® Attempting enhanced client layout initialization...');
                        layoutInitialized = await window.initializeAIFactoryRouter();
                        
                        if (layoutInitialized) {
                            console.log('‚úÖ Enhanced AI Factory client layout active');
                            
                            // Hide loading screen
                            if (loadingScreen) {
                                loadingScreen.style.display = 'none';
                            }
                            
                            // Initialize existing client dashboard in the new layout
                            setTimeout(async () => {
                                if (window.ClientDashboard && !window.clientDashboard) {
                                    try {
                                        window.clientDashboard = new ClientDashboard();
                                        await window.clientDashboard.initialize();
                                        console.log('‚úÖ Client dashboard initialized in enhanced layout');
                                    } catch (error) {
                                        console.warn('‚ö†Ô∏è Client dashboard initialization failed:', error);
                                    }
                                }
                            }, 100);
                            
                            return; // Exit early - enhanced layout is active
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Enhanced client layout initialization failed:', error);
                    }
                }

                // STEP 5: Fallback to Original Dashboard (existing logic)
                console.log('üìä Using original client dashboard layout');
                
                if (window.ClientDashboard && !window.clientDashboard) {
                    window.clientDashboard = new ClientDashboard();
                    await window.clientDashboard.initialize();
                    console.log('‚úÖ Original client dashboard initialized');
                } else {
                    console.warn('‚ö†Ô∏è ClientDashboard class not found');
                    appContainer.innerHTML = `
                        <div class="error-screen">
                            <div class="error-icon">‚ùå</div>
                            <h2>Dashboard Loading Failed</h2>
                            <p>Unable to initialize your dashboard.</p>
                            <button class="btn-primary" onclick="window.location.reload()">
                                üîÑ Retry
                            </button>
                            <button class="btn-secondary" onclick="logout()">
                                üö™ Logout
                            </button>
                        </div>
                    `;
                }

                // Hide loading screen
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }

            } catch (error) {
                console.error('‚ùå Client initialization failed:', error);
                
                // Show error screen
                appContainer.innerHTML = `
                    <div class="error-screen">
                        <div class="error-icon">üí•</div>
                        <h2>Initialization Error</h2>
                        <p>Failed to initialize your dashboard: ${error.message}</p>
                        <div class="error-actions">
                            <button class="btn-primary" onclick="window.location.reload()">
                                üîÑ Reload Page
                            </button>
                            <button class="btn-secondary" onclick="logout()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                `;
                
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }
        });

        // Global utility functions (preserve existing)
        window.logout = function() {
            localStorage.removeItem('bitware-session-token');
            localStorage.removeItem('bitware-user-info');
            localStorage.removeItem('bitware-kam-context');
            window.location.href = '/login.html';
        };

        // Client-specific navigation helpers
        window.navigateToReports = function() {
            if (window.kamRouter && window.kamRouter.initialized) {
                window.kamRouter.navigate('/reports');
            } else {
                alert('Reports section not yet available');
            }
        };

        window.navigateToAccount = function() {
            if (window.kamRouter && window.kamRouter.initialized) {
                window.kamRouter.navigate('/account');
            } else {
                alert('Account settings not yet available');
            }
        };

        // Debug helper
        window.debugAIFactory = function() {
            console.log('=== AI Factory Client Debug Info ===');
            console.log('Router Initialized:', !!window.kamRouter?.initialized);
            console.log('Layout Available:', !!window.AIFactoryLayout);
            console.log('KAM Context:', !!window.kamContext?.initialized);
            console.log('Client Dashboard:', !!window.clientDashboard);
            console.log('API Client:', !!window.apiClient);
            console.log('Session Token:', !!localStorage.getItem('bitware-session-token'));
            console.log('User Info:', localStorage.getItem('bitware-user-info'));
        };
    </script>
</body>
</html>